import CveTable from "../components/CveTable";
import React, { useState, useEffect } from "react";
import { fetchCves, fetchTotalCves } from "../utils/fetches";
import { AiOutlineCaretLeft, AiOutlineCaretRight } from "react-icons/ai";

const CveList = () => {
  const [cves, setCves] = useState([]);
  const [totalRecords, setTotalRecords] = useState(0);
  const [resultsPerPage, setResultsPerPage] = useState(10);
  const [currentPage, setCurrentPage] = useState(1);

  useEffect(() => {
    fetchCvesData();
    fetchTotalCvesData();
  }, [resultsPerPage, currentPage]);

  const fetchCvesData = async () => {
    try {
      const data = await fetchCves(currentPage, resultsPerPage);
      setCves(data.results);
    } catch (error) {
      console.error("Error fetching CVEs:", error.message);
    }
  };

  const fetchTotalCvesData = async () => {
    try {
      const data = await fetchTotalCves();
      setTotalRecords(data);
    } catch (error) {
      console.error("Error fetching total CVEs:", error.message);
    }
  };

  const handleResultsPerPageChange = (event) => {
    setResultsPerPage(parseInt(event.target.value));
    setCurrentPage(1);
  };

  const handlePageChange = (page) => {
    setCurrentPage(page);
  };

  return (
    <div className="w-9/12 mx-auto ">
      <h1 className="text-4xl font-bold mt-20 text-center">CVE LIST</h1>
      <p className="mt-20 text-start mb-2 ml-4 font-semibold">
        Total Records: {totalRecords}
      </p>
      <div className="flex justify-center items-center ">
        <CveTable cves={cves} />
      </div>
      {/* Pagination and Results per page dropdown */}
      <div className="flex justify-between ml-4 mt-4 mb-20">
        <div className="mr-8 flex items-center">
          <label htmlFor="resultsPerPage" className="mr-2 font-semibold">
            Results Per Page:{" "}
          </label>
          <select
            id="resultsPerPage"
            className="border border-gray-200 p-1  pr-8 rounded-sm appearance-none select-arrow bg-gray-100 hover:bg-gray-200"
            onChange={handleResultsPerPageChange}
            value={resultsPerPage}
          >
            <option value="10">10</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <div className="flex justify-between items-center mr-4">
          <p className="mr-4">
            {currentPage === 1
              ? `${currentPage}-${Math.min(
                  currentPage + resultsPerPage - 1,
                  totalRecords
                )} of ${totalRecords} Records`
              : `${(currentPage - 1) * resultsPerPage + 1}-${Math.min(
                  currentPage * resultsPerPage,
                  totalRecords
                )} of ${totalRecords} Records`}
          </p>

          <div className="flex border border-gray-400 rounded-md shadow-lg">
            <button
              className="bg-gray-300 hover:bg-gray-400  font-bold py-3 px-4 rounded-l-sm border-r-2 border-gray-400"
              onClick={() => handlePageChange(currentPage - 1)}
              disabled={currentPage === 1}
            >
              <AiOutlineCaretLeft />
            </button>
            {currentPage > 3 && (
              <button
                key={currentPage - 2}
                className="px-4 py-2 bg-gray-200 text-gray-800"
                onClick={() => handlePageChange(currentPage - 2)}
              >
                {currentPage - 2}
              </button>
            )}
            <button
              key={currentPage}
              className="px-4 py-2 bg-white"
              onClick={() => handlePageChange(currentPage)}
            >
              {currentPage}
            </button>
            {currentPage < Math.ceil(totalRecords / resultsPerPage) - 1 && (
              <button
                key={currentPage + 1}
                className="px-4 py-2 bg-gray-200 text-gray-800"
                onClick={() => handlePageChange(currentPage + 1)}
              >
                {currentPage + 1}
              </button>
            )}
            {currentPage < Math.ceil(totalRecords / resultsPerPage) - 2 && (
              <button
                key={currentPage + 2}
                className="px-4 py-2 bg-gray-200 text-gray-800"
                onClick={() => handlePageChange(currentPage + 2)}
              >
                {currentPage + 2}
              </button>
            )}
            <button
              className="bg-gray-300 hover:bg-gray-400  font-bold py-3 px-4 rounded-r-sm border-l-2 border-gray-400"
              onClick={() => handlePageChange(currentPage + 1)}
              disabled={
                currentPage === Math.ceil(totalRecords / resultsPerPage)
              }
            >
              <AiOutlineCaretRight />
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default CveList;
